{% extends "base.html" %}

{% block title %}Reports - Sri Vengamamba Food Court{% endblock %}

{% block content %}
<div class="mb-3">
    <button class="btn btn-outline-secondary" onclick="history.back()">
        <i class="bi bi-arrow-left me-2"></i><span data-lang="common.back">Back</span>
    </button>
    <hr>
  </div>
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-graph-up me-2"></i><span data-lang="reports.title">Sales Reports & Bills History</span></h2>
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="exportCSV()">
                    <i class="bi bi-download me-2"></i><span data-lang="reports.export_csv">Export CSV</span>
                </button>
                <button class="btn btn-outline-secondary" onclick="refreshReports()">
                    <i class="bi bi-arrow-clockwise me-2"></i><span data-lang="reports.refresh">Refresh</span>
                </button>
            </div>
        </div>

        <!-- Budget Filter Options -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Budget Filter Options</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Quick Filter Buttons -->
                            <div class="col-md-3">
                                <label class="form-label">Quick Filters</label>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="setQuickFilter('today')">
                                        <i class="bi bi-calendar-day me-2"></i>Today
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="setQuickFilter('week')">
                                        <i class="bi bi-calendar-week me-2"></i>This Week
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="setQuickFilter('month')">
                                        <i class="bi bi-calendar-month me-2"></i>This Month
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="setQuickFilter('year')">
                                        <i class="bi bi-calendar-year me-2"></i>This Year
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Date Range Filter -->
                            <div class="col-md-4">
                                <label for="date-from" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="date-from" onchange="updateBudgetFilter()">
                            </div>
                            <div class="col-md-4">
                                <label for="date-to" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="date-to" onchange="updateBudgetFilter()">
                            </div>
                            
                            <!-- Filter Actions -->
                            <div class="col-md-1 d-flex align-items-end">
                                <button class="btn btn-outline-secondary w-100" onclick="clearBudgetFilters()" title="Clear All Filters">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Current Filter Status -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info mb-0" id="filter-status">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span id="filter-status-text">Showing all bills</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title" id="bills-count-label">Total Bills</h6>
                                <h3 class="mb-0" id="bills-count">{{ bills|length }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-receipt" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title" id="sales-label">Total Sales</h6>
                                <h3 class="mb-0" id="total-sales">₹{{ "%.2f"|format(total_sales) }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-currency-dollar" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title" id="period-sales-label">Period Sales</h6>
                                <h3 class="mb-0" id="period-sales">₹{{ "%.2f"|format(total_sales) }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-calendar-day" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Average Bill</h6>
                                <h3 class="mb-0" id="avg-bill">₹{{ "%.2f"|format(avg_bill) }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="date-from" class="form-label" data-lang="reports.from_date">From Date</label>
                        <input type="date" class="form-control" id="date-from" onchange="filterBills()">
                    </div>
                    <div class="col-md-3">
                        <label for="date-to" class="form-label" data-lang="reports.to_date">To Date</label>
                        <input type="date" class="form-control" id="date-to" onchange="filterBills()">
                    </div>
                    <div class="col-md-3">
                        <label for="bill-search" class="form-label" data-lang="reports.search_bill">Search Bill</label>
                        <input type="text" class="form-control" id="bill-search" placeholder="Bill number..." onkeyup="filterBills()" data-lang="reports.bill_placeholder">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="bi bi-x-circle me-2"></i><span data-lang="reports.clear_filters">Clear Filters</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bills Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" data-lang="reports.bills_history">Bills History</h5>
            </div>
            <div class="card-body p-0">
                {% if bills %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="bills-table">
                        <thead>
                            <tr>
                                <th data-lang="reports.bill_number">Bill #</th>
                                <th data-lang="reports.date_time">Date & Time</th>
                                <th data-lang="reports.items">Items</th>
                                <th data-lang="reports.subtotal">Subtotal</th>
                                <th data-lang="reports.tax">Tax</th>
                                <th data-lang="reports.service">Service</th>
                                <th data-lang="reports.total">Total</th>
                                <th data-lang="reports.actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bill in bills %}
                            <tr data-bill-date="{{ bill.created_at[:10] }}" data-bill-number="{{ bill.bill_number }}">
                                <td>
                                    <strong>{{ bill.bill_number }}</strong>
                                </td>
                                <td>
                                    <div>{{ bill.created_at[:10] }}</div>
                                    <small class="text-muted">{{ bill.created_at[11:19] }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ bill.bill_items|length }} items</span>
                                    <div class="mt-1">
                                        {% for item in bill.bill_items[:2] %}
                                        <small class="d-block">{{ item.name }} ({{ item.quantity }})</small>
                                        {% endfor %}
                                        {% if bill.bill_items|length > 2 %}
                                        <small class="text-muted">+{{ bill.bill_items|length - 2 }} more</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <strong>₹{{ "%.2f"|format(bill.subtotal) }}</strong>
                                </td>
                                <td>
                                    ₹{{ "%.2f"|format(bill.tax_amount) }}
                                </td>
                                <td>
                                    ₹{{ "%.2f"|format(bill.service_charge) }}
                                </td>
                                <td>
                                    <strong class="text-success">₹{{ "%.2f"|format(bill.total) }}</strong>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="viewBill('{{ bill.bill_number }}')"
                                                data-bs-toggle="tooltip" title="View Bill" data-lang="reports.view">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" 
                                                onclick="printBill('{{ bill.bill_number }}')"
                                                data-bs-toggle="tooltip" title="Print Bill" data-lang="reports.print">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-receipt text-muted" style="font-size: 4rem;"></i>
                    <h4 class="text-muted mt-3" data-lang="reports.no_bills">No bills found</h4>
                    <p class="text-muted" data-lang="reports.start_generating">Start generating bills to see them here.</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary">
                        <i class="bi bi-plus me-2"></i><span data-lang="reports.create_first_bill">Create First Bill</span>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize reports page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Set default date range (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('date-to').value = today.toISOString().split('T')[0];
    
    // Apply initial filter
    updateBudgetFilter();
});

// Set quick filter dates
function setQuickFilter(period) {
    const today = new Date();
    let fromDate, toDate;
    
    switch(period) {
        case 'today':
            fromDate = toDate = today.toISOString().split('T')[0];
            break;
        case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            fromDate = weekStart.toISOString().split('T')[0];
            toDate = today.toISOString().split('T')[0];
            break;
        case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            fromDate = monthStart.toISOString().split('T')[0];
            toDate = today.toISOString().split('T')[0];
            break;
        case 'year':
            const yearStart = new Date(today.getFullYear(), 0, 1);
            fromDate = yearStart.toISOString().split('T')[0];
            toDate = today.toISOString().split('T')[0];
            break;
    }
    
    document.getElementById('date-from').value = fromDate;
    document.getElementById('date-to').value = toDate;
    updateBudgetFilter();
}

// Update budget filter and recalculate totals
function updateBudgetFilter() {
    const fromDate = document.getElementById('date-from').value;
    const toDate = document.getElementById('date-to').value;
    const searchTerm = document.getElementById('bill-search').value.toLowerCase();
    
    const rows = document.querySelectorAll('#bills-table tbody tr');
    let visibleCount = 0;
    let totalSales = 0;
    let periodSales = 0;
    
    rows.forEach(row => {
        const billDate = row.getAttribute('data-bill-date');
        const billNumber = row.getAttribute('data-bill-number').toLowerCase();
        const totalCell = row.querySelector('td:nth-child(7) strong');
        const billTotal = totalCell ? parseFloat(totalCell.textContent.replace('₹', '').replace(',', '')) : 0;
        
        let showRow = true;
        
        // Date filter
        if (fromDate && billDate < fromDate) {
            showRow = false;
        }
        if (toDate && billDate > toDate) {
            showRow = false;
        }
        
        // Search filter
        if (searchTerm && !billNumber.includes(searchTerm)) {
            showRow = false;
        }
        
        if (showRow) {
            visibleCount++;
            periodSales += billTotal;
        }
        
        row.style.display = showRow ? '' : 'none';
    });
    
    // Update summary cards
    document.getElementById('bills-count').textContent = visibleCount;
    document.getElementById('total-sales').textContent = '₹' + periodSales.toFixed(2);
    document.getElementById('period-sales').textContent = '₹' + periodSales.toFixed(2);
    
    // Update average bill
    const avgBill = visibleCount > 0 ? periodSales / visibleCount : 0;
    document.getElementById('avg-bill').textContent = '₹' + avgBill.toFixed(2);
    
    // Update filter status
    updateFilterStatus(fromDate, toDate, visibleCount, periodSales);
}

// Update filter status display
function updateFilterStatus(fromDate, toDate, count, sales) {
    const statusText = document.getElementById('filter-status-text');
    let status = '';
    
    if (fromDate && toDate) {
        if (fromDate === toDate) {
            status = `Showing bills for ${fromDate} (${count} bills, ₹${sales.toFixed(2)})`;
        } else {
            status = `Showing bills from ${fromDate} to ${toDate} (${count} bills, ₹${sales.toFixed(2)})`;
        }
    } else if (fromDate) {
        status = `Showing bills from ${fromDate} onwards (${count} bills, ₹${sales.toFixed(2)})`;
    } else if (toDate) {
        status = `Showing bills up to ${toDate} (${count} bills, ₹${sales.toFixed(2)})`;
    } else {
        status = `Showing all bills (${count} bills, ₹${sales.toFixed(2)})`;
    }
    
    statusText.textContent = status;
}

// Clear all budget filters
function clearBudgetFilters() {
    document.getElementById('date-from').value = '';
    document.getElementById('date-to').value = '';
    document.getElementById('bill-search').value = '';
    updateBudgetFilter();
}

// Legacy function for backward compatibility
function filterBills() {
    updateBudgetFilter();
}

// Clear all filters
function clearFilters() {
    clearBudgetFilters();
}

// View bill details
function viewBill(billNumber) {
    window.location.href = `/bill/${billNumber}`;
}

// Print bill
function printBill(billNumber) {
    const printWindow = window.open(`/bill/${billNumber}`, '_blank');
    printWindow.onload = function() {
        printWindow.print();
    };
}

// Export CSV with item analysis
async function exportCSV() {
    try {
        // Get current filter dates
        const fromDate = document.getElementById('date-from').value;
        const toDate = document.getElementById('date-to').value;
        
        // Get visible bills data first
        const rows = document.querySelectorAll('#bills-table tbody tr:not([style*="display: none"])');
        let billsData = [];
        let itemAnalysis = new Map();
        let totalSales = 0;
        
        // Process each bill to extract item data
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 7) {
                const billNumber = cells[0].textContent.trim();
                const dateTime = cells[1].textContent.trim().replace(/\n/g, ' ').replace(/\s+/g, ' ');
                const items = cells[2].querySelector('.badge').textContent.trim();
                const subtotal = cells[3].textContent.trim();
                const tax = cells[4].textContent.trim();
                const service = cells[5].textContent.trim();
                const total = cells[6].textContent.trim();
                
                // Parse total amount
                const totalAmount = parseFloat(total.replace(/[₹,]/g, ''));
                if (!isNaN(totalAmount)) {
                    totalSales += totalAmount;
                }
                
                // Extract individual items from the items cell
                const itemElements = cells[2].querySelectorAll('small');
                let itemDetails = [];
                
                itemElements.forEach(itemEl => {
                    const text = itemEl.textContent.trim();
                    if (text && !text.includes('more')) {
                        // Parse format: "Item Name (quantity)"
                        const match = text.match(/^(.+?)\s*\((\d+)\)$/);
                        if (match) {
                            const itemName = match[1].trim();
                            const quantity = parseInt(match[2]);
                            
                            itemDetails.push(`${itemName} (${quantity})`);
                            
                            // Estimate price (this is approximate since we don't have exact item prices)
                            const estimatedPrice = totalAmount / quantity;
                            
                            if (itemAnalysis.has(itemName)) {
                                const existing = itemAnalysis.get(itemName);
                                existing.quantity += quantity;
                                existing.totalSales += estimatedPrice * quantity;
                                existing.price = (existing.price + estimatedPrice) / 2; // Average price
                            } else {
                                itemAnalysis.set(itemName, {
                                    quantity: quantity,
                                    price: estimatedPrice,
                                    totalSales: estimatedPrice * quantity
                                });
                            }
                        }
                    }
                });
                
                // Update the items field with detailed item list
                const detailedItems = itemDetails.join(', ');
                
                const billData = {
                    billNumber, 
                    dateTime, 
                    items: detailedItems || items, 
                    subtotal, 
                    tax, 
                    service, 
                    total
                };
                
                console.log('Bill Data:', billData);
                billsData.push(billData);
            }
        });
        
        // Create CSV content with proper structure
        let csvContent = '';
        
        // Header section
        csvContent += 'SRI VENGAMAMBA FOOD COURT - SALES REPORT\n';
        csvContent += '=====================================\n\n';
        
        // Date range info
        if (fromDate && toDate) {
            if (fromDate === toDate) {
                csvContent += `Report Date: ${fromDate}\n`;
            } else {
                csvContent += `Report Period: ${fromDate} to ${toDate}\n`;
            }
        } else {
            csvContent += `Report Generated: ${new Date().toISOString().split('T')[0]}\n`;
        }
        csvContent += `Total Bills: ${billsData.length}\n`;
        csvContent += `Total Sales: Rs.${totalSales.toFixed(2)}\n\n`;
        
        // Item Analysis Section
        csvContent += 'ITEM ANALYSIS (Ranked by Sales)\n';
        csvContent += '==============================\n';
        csvContent += 'Item,Quantity,Cost\n';
        
        // Sort items by total sales (highest first)
        const sortedItems = Array.from(itemAnalysis.entries())
            .sort((a, b) => b[1].totalSales - a[1].totalSales);
        
        console.log('Item Analysis Data:', sortedItems);
        console.log('Total Items Found:', sortedItems.length);
        
        if (sortedItems.length > 0) {
            sortedItems.forEach(([itemName, data]) => {
                csvContent += `"${itemName}",${data.quantity},Rs.${data.totalSales.toFixed(2)}\n`;
            });
        } else {
            csvContent += 'No item data available\n';
        }
        
        csvContent += '\n';
        
        // Bills Detail Section
        csvContent += 'BILLS DETAIL\n';
        csvContent += '============\n';
        csvContent += 'Bill Number,Date & Time,Item Details,Subtotal,Tax,Service Charge,Total\n';
        
        billsData.forEach((bill, index) => {
            // Clean currency symbols for better CSV compatibility
            const cleanSubtotal = bill.subtotal.replace(/[₹,]/g, '');
            const cleanTax = bill.tax.replace(/[₹,]/g, '');
            const cleanService = bill.service.replace(/[₹,]/g, '');
            const cleanTotal = bill.total.replace(/[₹,]/g, '');
            
            // Clean and escape any quotes in the data
            const cleanBillNumber = bill.billNumber.replace(/"/g, '""');
            const cleanDateTime = bill.dateTime.replace(/"/g, '""');
            const cleanItems = bill.items.replace(/"/g, '""');
            
            console.log(`Bill ${index + 1}:`, {
                billNumber: cleanBillNumber,
                dateTime: cleanDateTime,
                items: cleanItems,
                subtotal: cleanSubtotal,
                tax: cleanTax,
                service: cleanService,
                total: cleanTotal
            });
            
            // Ensure proper CSV formatting with quotes around all fields
            csvContent += `"${cleanBillNumber}","${cleanDateTime}","${cleanItems}","Rs.${cleanSubtotal}","Rs.${cleanTax}","Rs.${cleanService}","Rs.${cleanTotal}"\n`;
        });
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Generate filename based on current filter
        let filename = 'sales_report_';
        if (fromDate && toDate) {
            if (fromDate === toDate) {
                filename += fromDate;
            } else {
                filename += `${fromDate}_to_${toDate}`;
            }
        } else {
            filename += new Date().toISOString().split('T')[0];
        }
        
        a.download = `${filename}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showAlert('Enhanced CSV report with item analysis downloaded successfully!', 'success');
        
    } catch (error) {
        console.error('Error generating CSV:', error);
        showAlert('Error generating CSV report. Please try again.', 'danger');
    }
}


// Refresh reports
function refreshReports() {
    location.reload();
}
</script>
{% endblock %}
