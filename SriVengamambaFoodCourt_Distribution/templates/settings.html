{% extends "base.html" %}

{% block title %}Settings - Sri Vengamamba Food Court{% endblock %}

{% block content %}
<div class="mb-3">
    <button class="btn btn-outline-secondary" onclick="history.back()">
        <i class="bi bi-arrow-left me-2"></i><span data-lang="common.back">Back</span>
    </button>
    <hr>
</div>
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear me-2"></i><span data-lang="settings.title">System Settings</span>
                </h5>
            </div>
            <div class="card-body">
                <form id="settingsForm" onsubmit="event.preventDefault(); updateSettings();">
                    <!-- Restaurant Information -->
                    <div class="mb-5">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-shop me-2"></i><span data-lang="settings.restaurant_info">Restaurant Information</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="restaurant-name" class="form-label" data-lang="settings.restaurant_name">Restaurant Name *</label>
                                    <input type="text" class="form-control" id="restaurant-name" name="restaurant_name" 
                                           value="{{ settings.restaurant_name }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="restaurant-phone" class="form-label" data-lang="settings.restaurant_phone">Phone Number</label>
                                    <input type="tel" class="form-control" id="restaurant-phone" name="restaurant_phone" 
                                           value="{{ settings.restaurant_phone }}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="restaurant-address" class="form-label" data-lang="settings.restaurant_address">Address</label>
                                    <textarea class="form-control" id="restaurant-address" name="restaurant_address" 
                                              rows="2">{{ settings.restaurant_address }}</textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="restaurant-gst" class="form-label">GST Number</label>
                                    <input type="text" class="form-control" id="restaurant-gst" name="restaurant_gst" 
                                           value="{{ settings.restaurant_gst }}" placeholder="33AAAGP0685F1ZH">
                                    <small class="text-muted">Enter your GST registration number</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Billing Settings -->
                    <div class="mb-5">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-calculator me-2"></i><span data-lang="settings.billing_settings">Billing Settings</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tax-rate" class="form-label" data-lang="settings.tax_rate">Tax Rate (%) *</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="tax-rate" name="tax_rate" 
                                               value="{{ settings.tax_rate }}" step="0.1" min="0" max="100" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="text-muted">Tax percentage applied to subtotal</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="service-charge-rate" class="form-label" data-lang="settings.service_charge_rate">Service Charge (%) *</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="service-charge-rate" name="service_charge_rate" 
                                               value="{{ settings.service_charge_rate }}" step="0.1" min="0" max="100" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="text-muted">Service charge percentage applied to subtotal</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Language Settings -->
                    <div class="mb-5">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-translate me-2"></i>Language Settings
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="language-select" class="form-label">Application Language</label>
                                    <select class="form-select" id="language-select" name="language" onchange="switchLanguageFromSettings(this.value)">
                                        <option value="en">English</option>
                                        <option value="te">తెలుగు (Telugu)</option>
                                    </select>
                                    <small class="text-muted">Choose your preferred language for the application</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Language</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="current-language-display" readonly>
                                    </div>
                                    <small class="text-muted">Currently selected language</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Activity Logs -->
                    <div class="mb-5">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-person-lines-fill me-2"></i>User Activity Logs
                        </h6>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-outline-secondary" onclick="viewUserLogs()">
                                    <i class="bi bi-list-ul me-2"></i>View User Activity Logs
                                </button>
                                <small class="text-muted d-block mt-1">View login logs and user activities</small>
                            </div>
                        </div>
                    </div>

                    <!-- Database Management -->
                    <div class="mb-5">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-database-gear me-2"></i>Database Management
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-info" onclick="checkDatabase()">
                                    <i class="bi bi-shield-check me-2"></i>Check Database Status
                                </button>
                                <small class="text-muted d-block mt-1">Check and fix database lock issues</small>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-success" onclick="testBillNumber()">
                                    <i class="bi bi-receipt me-2"></i>Test Bill Number
                                </button>
                                <small class="text-muted d-block mt-1">Test new bill number format</small>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="resetSettings()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reset to Defaults
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check me-2"></i><span data-lang="settings.save">Save Settings</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-database text-primary" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">Database</h6>
                        <p class="text-muted small">Manage your data</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportData()">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-printer text-primary" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">Print Settings</h6>
                        <p class="text-muted small">Configure printing</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="testPrint()">
                            <i class="bi bi-printer me-1"></i>Test Print
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-shield-check text-primary" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">Backup</h6>
                        <p class="text-muted small">Backup your data</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="createBackup()">
                            <i class="bi bi-cloud-upload me-1"></i>Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize settings page
document.addEventListener('DOMContentLoaded', function() {
    // Load current settings
    loadCurrentSettings();
    // Initialize language settings
    initializeLanguageSettings();
    
    // Listen for language change events
    document.addEventListener('languageChanged', function(event) {
        updateCurrentLanguageDisplay(event.detail.language);
    });
});

// Load current settings
function loadCurrentSettings() {
    // Settings are already loaded from the server in the template
    console.log('Settings loaded');
}

// Reset settings to defaults
function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to default values?')) {
        document.getElementById('restaurant-name').value = 'My Restaurant';
        document.getElementById('restaurant-phone').value = '+1-234-567-8900';
        document.getElementById('restaurant-address').value = '123 Main Street, City';
        document.getElementById('restaurant-gst').value = '';
        document.getElementById('tax-rate').value = '10.0';
        document.getElementById('service-charge-rate').value = '5.0';
        
        showAlert('Settings reset to defaults. Click Save to apply changes.', 'info');
    }
}

// Export data
function exportData() {
    showAlert('Data export feature coming soon!', 'info');
}

// Test print
function testPrint() {
    showAlert('Print test feature coming soon!', 'info');
}

// Create backup
function createBackup() {
    showAlert('Backup feature coming soon!', 'info');
}

// View user logs
async function viewUserLogs() {
    try {
        const response = await fetch('/api/user_logs');
        const result = await response.json();
        
        if (result.success) {
            // Create a modal to display logs
            showUserLogsModal(result.login_logs, result.activity_logs);
        } else {
            showAlert('Failed to load user logs', 'error');
        }
    } catch (error) {
        console.error('Error loading user logs:', error);
        showAlert('Failed to load user logs', 'error');
    }
}

// Show user logs modal
function showUserLogsModal(loginLogs, activityLogs) {
    // Create modal HTML
    const modalHtml = `
        <div class="modal fade" id="userLogsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">User Activity Logs</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="logsTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-logs" type="button">Login Logs</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity-logs" type="button">Activity Logs</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="logsTabContent">
                            <div class="tab-pane fade show active" id="login-logs">
                                <div class="table-responsive mt-3">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Role</th>
                                                <th>Login Time</th>
                                                <th>Logout Time</th>
                                                <th>Duration</th>
                                                <th>IP Address</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${loginLogs.map(log => `
                                                <tr>
                                                    <td>${log.username}</td>
                                                    <td><span class="badge bg-${log.role === 'admin' ? 'danger' : 'primary'}">${log.role}</span></td>
                                                    <td>${new Date(log.login_time).toLocaleString()}</td>
                                                    <td>${log.logout_time ? new Date(log.logout_time).toLocaleString() : 'Active'}</td>
                                                    <td>${log.session_duration ? Math.floor(log.session_duration / 60) + ' min' : 'N/A'}</td>
                                                    <td>${log.ip_address || 'N/A'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="activity-logs">
                                <div class="table-responsive mt-3">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Activity</th>
                                                <th>Description</th>
                                                <th>Bill Number</th>
                                                <th>Time</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${activityLogs.map(log => `
                                                <tr>
                                                    <td>${log.username}</td>
                                                    <td><span class="badge bg-info">${log.activity_type}</span></td>
                                                    <td>${log.activity_description}</td>
                                                    <td>${log.bill_number || 'N/A'}</td>
                                                    <td>${new Date(log.created_at).toLocaleString()}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('userLogsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('userLogsModal'));
    modal.show();
}

// Initialize language settings
function initializeLanguageSettings() {
    // Get current language from localStorage
    const currentLanguage = localStorage.getItem('language') || 'en';
    
    // Set the language select value
    const languageSelect = document.getElementById('language-select');
    if (languageSelect) {
        languageSelect.value = currentLanguage;
    }
    
    // Update the current language display
    updateCurrentLanguageDisplay(currentLanguage);
}

// Update current language display
function updateCurrentLanguageDisplay(language) {
    const displayElement = document.getElementById('current-language-display');
    if (displayElement) {
        displayElement.value = language === 'te' ? 'తెలుగు (Telugu)' : 'English';
    }
}

// Handle language switching from settings
function switchLanguageFromSettings(lang) {
    // Call the global switchLanguage function
    if (typeof window.switchLanguage === 'function') {
        window.switchLanguage(lang);
    }
    
    // Show success message
    const message = lang === 'te' ? 'భాష మార్చబడింది!' : 'Language changed!';
    showAlert(message, 'success');
}

// Check database status
async function checkDatabase() {
    try {
        showAlert('Checking database status...', 'info');
        
        const response = await fetch('/api/check_database');
        const result = await response.json();
        
        if (result.success) {
            showAlert('✅ ' + result.message, 'success');
        } else {
            showAlert('❌ ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error checking database:', error);
        showAlert('Failed to check database status', 'error');
    }
}

// Test bill number generation
async function testBillNumber() {
    try {
        showAlert('Testing bill number generation...', 'info');
        
        const response = await fetch('/api/test_bill_number');
        const result = await response.json();
        
        if (result.success) {
            const message = `Bill Number Format Test:\n\n` +
                          `Sample Bill Number: ${result.sample_bill_number}\n` +
                          `Prefix: ${result.prefix} (${result.prefix === 'F' ? 'Morning' : 'Afternoon'})\n` +
                          `Date: ${result.date_str}\n` +
                          `Sequence: ${result.next_seq}\n` +
                          `Current Hour: ${result.current_hour}`;
            
            showAlert(message, 'success');
            
            // Test if the bill preview URL would work
            const testUrl = `/bill/${result.sample_bill_number}`;
            console.log('Test bill URL would be:', testUrl);
        } else {
            showAlert('❌ ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error testing bill number:', error);
        showAlert('Failed to test bill number generation', 'error');
    }
}
</script>
{% endblock %}